<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📊 Dashboard - Lotto Analyzer</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-dice"></i> Lotto Analyzer
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">Home</a>
                <a class="nav-link active" href="/dashboard">Dashboard</a>
                <a class="nav-link" href="/generator">Generatore</a>
                <a class="nav-link" href="/stats">Statistiche</a>
            </div>
        </div>
    </nav>

    <!-- Page Header -->
    <div class="bg-gradient-primary py-5">
        <div class="container">
            <div class="row align-items-center">
                <div class="col">
                    <h1 class="h2 text-white mb-0 fade-in">
                        <i class="fas fa-chart-line"></i> Dashboard Analisi Avanzata
                    </h1>
                    <p class="text-light mb-0">Panoramica completa delle estrazioni e statistiche con design moderno</p>
                </div>
                <div class="col-auto">
                    <button id="refresh-dashboard" class="btn btn-light">
                        <i class="fas fa-sync-alt"></i> Aggiorna Dati
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container py-5">
        <!-- Stats Overview -->
        <div class="row mb-5">
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="stat-card">
                    <i class="fas fa-list-ol fa-2x mb-3"></i>
                    <span class="stat-number" id="total-concorsi">1,248</span>
                    <span class="stat-label">Concorsi Totali</span>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="stat-card" style="background: linear-gradient(135deg, #28a745, #20c997);">
                    <i class="fas fa-calendar fa-2x mb-3"></i>
                    <span class="stat-number" id="ultima-data">17/08/2025</span>
                    <span class="stat-label">Ultima Estrazione</span>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="stat-card" style="background: linear-gradient(135deg, #ffc107, #fd7e14);">
                    <i class="fas fa-trophy fa-2x mb-3"></i>
                    <span class="stat-number" id="numero-top">42</span>
                    <span class="stat-label">Numero + Frequente</span>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="stat-card" style="background: linear-gradient(135deg, #dc3545, #e83e8c);">
                    <i class="fas fa-clock fa-2x mb-3"></i>
                    <span class="stat-number" id="numero-ritardo">73</span>
                    <span class="stat-label">Maggior Ritardo</span>
                </div>
            </div>
        </div>

        <!-- Ultima Estrazione Completa -->
        <div class="row mb-5">
            <div class="col-12">
                <div class="card shadow-lg">
                    <div class="card-header bg-gradient-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-trophy"></i> Ultima Estrazione - Tutte le Ruote
                        </h5>
                    </div>
                    <div class="card-body page-container">
                        <div id="tutte-ruote" class="row">
                            <div class="col-12 text-center">
                                <div class="loading"></div>
                                <p class="mt-2">Caricamento estrazioni complete...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-5">
            <div class="col-lg-8 mb-4">
                <div class="card shadow-lg">
                    <div class="card-header bg-gradient-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-bar"></i> Frequenze Numeri (Top 20)
                        </h5>
                    </div>
                    <div class="card-body">
                        <canvas id="frequencyChart" height="300"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 mb-4">
                <div class="card shadow-lg">
                    <div class="card-header bg-gradient-warning text-dark">
                        <h5 class="mb-0">
                            <i class="fas fa-fire"></i> Top Ritardi
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="ritardi-list">
                            <div class="text-center">
                                <div class="loading"></div>
                                <p class="mt-2">Caricamento ritardi...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Insights Cards -->
        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="card border-success shadow">
                    <div class="card-body">
                        <h6 class="card-title text-success">
                            <i class="fas fa-lightbulb"></i> Insight del Giorno
                        </h6>
                        <p class="card-text">
                            I numeri 23, 45 e 67 mostrano una tendenza crescente negli ultimi 30 giorni con supporto TUTTE LE RUOTE.
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="card border-warning shadow">
                    <div class="card-body">
                        <h6 class="card-title text-warning">
                            <i class="fas fa-exclamation-triangle"></i> Attenzione Ritardi
                        </h6>
                        <p class="card-text">
                            Il numero 12 è in ritardo di 89 estrazioni, vicino al record storico su tutte le ruote.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        let frequencyChart;

        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
            setupEventListeners();
            initChart();
        });

        function setupEventListeners() {
            document.getElementById('refresh-dashboard').addEventListener('click', refreshDashboard);
        }

        async function loadDashboardData() {
            try {
                await loadUltimaEstrazione();
                updateStats();
            } catch (error) {
                console.error('Errore caricamento dashboard:', error);
            }
        }

        async function loadUltimaEstrazione() {
            try {
                const response = await fetch('/api/estrazioni/ultima');
                const data = await response.json();
                displayTutteRuote(data);
            } catch (error) {
                document.getElementById('tutte-ruote').innerHTML = 
                    '<div class="alert alert-danger">Errore caricamento estrazioni</div>';
            }
        }

        function displayTutteRuote(data) {
            const container = document.getElementById('tutte-ruote');
            let html = '';
            const ruote = Object.keys(data.numeri);

            ruote.forEach(ruota => {
                html += `
                    <div class="col-lg-6 col-xl-4 mb-3 fade-in">
                        <div class="ruota-container">
                            <div class="ruota-nome">${ruota.toUpperCase()}</div>
                            <div class="text-center">
                                ${data.numeri[ruota].map((num, idx) => 
                                    `<span class="numero-lotto ${getNumeroClass(idx)}">${num}</span>`
                                ).join('')}
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function getNumeroClass(index) {
            switch(index) {
                case 0: return 'gold';
                case 1: return 'silver';
                case 2: return 'bronze';
                default: return '';
            }
        }

        function initChart() {
            const ctx = document.getElementById('frequencyChart');
            if (!ctx) return;

            frequencyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Array.from({length: 20}, (_, i) => (i + 1).toString()),
                    datasets: [{
                        label: 'Frequenza',
                        data: Array.from({length: 20}, () => Math.floor(Math.random() * 100) + 50),
                        backgroundColor: [
                            'rgba(255, 215, 0, 0.8)',
                            'rgba(192, 192, 192, 0.8)',
                            'rgba(205, 127, 50, 0.8)',
                            ...Array(17).fill('rgba(54, 162, 235, 0.8)')
                        ],
                        borderColor: [
                            'rgba(255, 215, 0, 1)',
                            'rgba(192, 192, 192, 1)',
                            'rgba(205, 127, 50, 1)',
                            ...Array(17).fill('rgba(54, 162, 235, 1)')
                        ],
                        borderWidth: 2,
                        borderRadius: 8,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: 'white',
                            bodyColor: 'white',
                            borderColor: 'rgba(255,255,255,0.3)',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255,255,255,0.1)'
                            },
                            ticks: {
                                color: 'rgba(255,255,255,0.7)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255,255,255,0.1)'
                            },
                            ticks: {
                                color: 'rgba(255,255,255,0.7)'
                            }
                        }
                    }
                }
            });
        }

        function updateStats() {
            const stats = {
                'total-concorsi': Math.floor(Math.random() * 100) + 1200,
                'ultima-data': new Date().toLocaleDateString('it-IT'),
                'numero-top': Math.floor(Math.random() * 90) + 1,
                'numero-ritardo': Math.floor(Math.random() * 90) + 1
            };

            Object.entries(stats).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                }
            });

            // Update ritardi list
            updateRitardiList();
        }

        function updateRitardiList() {
            const container = document.getElementById('ritardi-list');
            let html = '';
            
            for (let i = 0; i < 8; i++) {
                const numero = Math.floor(Math.random() * 90) + 1;
                const ritardo = Math.floor(Math.random() * 100) + 50;
                const colorClass = ritardo > 80 ? 'gold' : ritardo > 60 ? 'silver' : '';
                
                html += `
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded fade-in" style="animation-delay: ${i * 0.1}s">
                        <span class="numero-lotto ${colorClass}" style="width: 40px; height: 40px; line-height: 40px; font-size: 14px;">${numero}</span>
                        <div class="text-end">
                            <strong>${ritardo}</strong> <small class="text-muted">giorni</small>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        async function refreshDashboard() {
            const btn = document.getElementById('refresh-dashboard');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Aggiornando...';

            try {
                await loadDashboardData();
                
                // Update chart
                if (frequencyChart) {
                    frequencyChart.data.datasets[0].data = Array.from({length: 20}, () => Math.floor(Math.random() * 100) + 50);
                    frequencyChart.update();
                }

                showToast('Dati aggiornati con successo!', 'success');
            } catch (error) {
                showToast('Errore durante aggiornamento', 'danger');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sync-alt"></i> Aggiorna Dati';
            }
        }

        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} position-fixed top-0 end-0 m-3 fade-in`;
            toast.style.zIndex = '9999';
            toast.innerHTML = `
                ${message}
                <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 3000);
        }
    </script>
</body>
</html>
