<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📊 Statistiche - Lotto Analyzer</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-dice"></i> Lotto Analyzer
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <div class="navbar-nav ms-auto">
                    <a class="nav-link" href="/">Home</a>
                    <a class="nav-link" href="/dashboard">Dashboard</a>
                    <a class="nav-link" href="/generator">Generatore</a>
                    <a class="nav-link active" href="/stats">Statistiche</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Page Header -->
    <div class="bg-gradient-info py-5">
        <div class="container text-center">
            <h1 class="display-4 text-white mb-3 fade-in sparkle">
                <i class="fas fa-chart-pie"></i> Statistiche Avanzate
            </h1>
            <p class="lead text-light">Analisi complete su frequenze, ritardi e tendenze storiche con supporto TUTTE LE RUOTE</p>
        </div>
    </div>

    <div class="container py-5">
        <!-- Filter Controls -->
        <div class="row mb-5">
            <div class="col-12">
                <div class="card shadow-lg">
                    <div class="card-header bg-gradient-warning text-dark">
                        <h5 class="mb-0">
                            <i class="fas fa-filter"></i> Controlli Analisi
                        </h5>
                    </div>
                    <div class="card-body page-container">
                        <div class="row align-items-end">
                            <div class="col-md-3 mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-chart-bar text-primary"></i> Tipo Analisi
                                </label>
                                <select id="tipo-analisi" class="form-select">
                                    <option value="frequenze">📊 Frequenze</option>
                                    <option value="ritardi">⏰ Ritardi</option>
                                    <option value="coppie">👥 Coppie Frequenti</option>
                                    <option value="sequenze">🔢 Sequenze</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-globe text-success"></i> Ruota
                                </label>
                                <select id="ruota-stats" class="form-select">
                                    <option value="tutte">🌍 TUTTE LE RUOTE</option>
                                    <option value="nazionale">🇮🇹 Nazionale</option>
                                    <option value="bari">🏛️ Bari</option>
                                    <option value="cagliari">🏖️ Cagliari</option>
                                    <option value="firenze">🎨 Firenze</option>
                                    <option value="genova">⚓ Genova</option>
                                    <option value="milano">🏙️ Milano</option>
                                    <option value="napoli">🍕 Napoli</option>
                                    <option value="palermo">🌴 Palermo</option>
                                    <option value="roma">🏛️ Roma</option>
                                    <option value="torino">⛰️ Torino</option>
                                    <option value="venezia">🚤 Venezia</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-calendar text-warning"></i> Periodo
                                </label>
                                <select id="periodo-stats" class="form-select">
                                    <option value="30">Ultimi 30 giorni</option>
                                    <option value="90" selected>Ultimi 3 mesi</option>
                                    <option value="365">Ultimo anno</option>
                                    <option value="all">Tutti i dati</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <button id="aggiorna-stats" class="btn btn-info w-100">
                                    <i class="fas fa-sync-alt"></i> Aggiorna Dati
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Grid -->
        <div class="row mb-5">
            <!-- Main Chart -->
            <div class="col-lg-8 mb-4">
                <div class="card shadow-lg">
                    <div class="card-header bg-gradient-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-bar"></i> 
                            <span id="chart-title">Frequenze Numeri</span>
                        </h5>
                    </div>
                    <div class="card-body">
                        <canvas id="mainStatsChart" height="300"></canvas>
                    </div>
                </div>
            </div>

            <!-- Top Numbers -->
            <div class="col-lg-4 mb-4">
                <div class="card shadow-lg">
                    <div class="card-header bg-gradient-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-trophy"></i> Top 10 Numeri
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="top-numbers-list">
                            <div class="text-center">
                                <div class="loading"></div>
                                <p class="mt-2">Caricamento top numeri...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Heatmap and Details -->
        <div class="row mb-5">
            <div class="col-lg-8 mb-4">
                <div class="card shadow-lg">
                    <div class="card-header bg-gradient-warning text-dark">
                        <h5 class="mb-0">
                            <i class="fas fa-fire"></i> Mappa di Calore Frequenze
                        </h5>
                    </div>
                    <div class="card-body page-container">
                        <div id="heatmap-container">
                            <div class="row" id="heatmap-grid">
                                <!-- Heatmap generata dinamicamente -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4 mb-4">
                <div class="card shadow-lg">
                    <div class="card-header bg-gradient-danger text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-clock"></i> Ritardi Massimi
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="ritardi-dettaglio">
                            <div class="text-center">
                                <div class="loading"></div>
                                <p class="mt-2">Caricamento ritardi...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Insights Cards -->
        <div class="row mb-5">
            <div class="col-md-6 mb-3">
                <div class="card border-success shadow">
                    <div class="card-body">
                        <h6 class="card-title text-success">
                            <i class="fas fa-lightbulb"></i> Insight del Giorno
                        </h6>
                        <p class="card-text" id="daily-insight">
                            I numeri 23, 45 e 67 mostrano una tendenza crescente negli ultimi 30 giorni su TUTTE LE RUOTE.
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="card border-warning shadow">
                    <div class="card-body">
                        <h6 class="card-title text-warning">
                            <i class="fas fa-exclamation-triangle"></i> Attenzione Ritardi
                        </h6>
                        <p class="card-text" id="warning-insight">
                            Il numero 12 è in ritardo di 89 estrazioni su tutte le ruote, vicino al record storico.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Stats Cards -->
        <div class="row">
            <div class="col-md-3 mb-4">
                <div class="stat-card" style="background: linear-gradient(135deg, #6f42c1, #5a2d91);">
                    <i class="fas fa-chart-line fa-2x mb-3"></i>
                    <span class="stat-number" id="avg-frequency">156</span>
                    <span class="stat-label">Frequenza Media</span>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="stat-card" style="background: linear-gradient(135deg, #fd7e14, #e55a00);">
                    <i class="fas fa-clock fa-2x mb-3"></i>
                    <span class="stat-number" id="avg-delay">42</span>
                    <span class="stat-label">Ritardo Medio</span>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="stat-card" style="background: linear-gradient(135deg, #20c997, #17a085);">
                    <i class="fas fa-fire fa-2x mb-3"></i>
                    <span class="stat-number" id="hot-numbers">7</span>
                    <span class="stat-label">Numeri "Caldi"</span>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="stat-card" style="background: linear-gradient(135deg, #6610f2, #520dc2);">
                    <i class="fas fa-snowflake fa-2x mb-3"></i>
                    <span class="stat-number" id="cold-numbers">12</span>
                    <span class="stat-label">Numeri "Freddi"</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        let mainChart;

        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            initChart();
            loadStatsData();
            generateHeatmap();
        });

        function setupEventListeners() {
            document.getElementById('aggiorna-stats').addEventListener('click', updateStats);
            
            ['tipo-analisi', 'ruota-stats', 'periodo-stats'].forEach(id => {
                document.getElementById(id).addEventListener('change', updateStats);
            });
        }

        function initChart() {
            const ctx = document.getElementById('mainStatsChart');
            if (!ctx) return;

            mainChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Valore',
                        data: [],
                        backgroundColor: [],
                        borderColor: [],
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: 'white',
                            bodyColor: 'white'
                        }
                    },
                    scales: {
                        y: { beginAtZero: true },
                        x: { }
                    }
                }
            });
        }

        function loadStatsData() {
            // Genera dati demo
            const labels = Array.from({length: 30}, (_, i) => (i + 1).toString());
            const data = Array.from({length: 30}, () => Math.floor(Math.random() * 100) + 50);
            
            updateChart(labels, data);
            updateTopNumbers();
            updateRitardiDettaglio();
            updateQuickStats();
        }

        function updateChart(labels, data) {
            if (!mainChart) return;

            const colors = data.map((val, idx) => {
                if (idx === 0) return 'rgba(255, 215, 0, 0.8)';
                if (idx === 1) return 'rgba(192, 192, 192, 0.8)';
                if (idx === 2) return 'rgba(205, 127, 50, 0.8)';
                return 'rgba(54, 162, 235, 0.8)';
            });

            mainChart.data.labels = labels;
            mainChart.data.datasets[0].data = data;
            mainChart.data.datasets[0].backgroundColor = colors;
            mainChart.data.datasets[0].borderColor = colors.map(c => c.replace('0.8', '1'));
            mainChart.update();
        }

        function updateTopNumbers() {
            const container = document.getElementById('top-numbers-list');
            let html = '';
            
            for (let i = 0; i < 10; i++) {
                const numero = Math.floor(Math.random() * 90) + 1;
                const valore = Math.floor(Math.random() * 100) + 100;
                const iconClass = i < 3 ? 'fa-crown' : i < 6 ? 'fa-medal' : 'fa-star';
                const badgeClass = i < 3 ? 'gold' : i < 6 ? 'silver' : 'bronze';
                
                html += `
                    <div class="d-flex justify-content-between align-items-center mb-3 p-2 border rounded fade-in" style="animation-delay: ${i * 0.1}s">
                        <div class="d-flex align-items-center">
                            <i class="fas ${iconClass} me-2 text-warning"></i>
                            <span class="numero-lotto ${badgeClass} me-2" style="width: 35px; height: 35px; line-height: 35px; font-size: 14px;">${numero}</span>
                        </div>
                        <span class="badge bg-primary">${valore}</span>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        function generateHeatmap() {
            const container = document.getElementById('heatmap-grid');
            let html = '';
            
            for (let i = 1; i <= 90; i++) {
                const intensity = Math.random();
                const colorClass = getHeatmapColor(intensity);
                
                html += `
                    <div class="col-1 mb-1">
                        <div class="numero-lotto ${colorClass}" style="width: 100%; height: 40px; line-height: 40px; font-size: 12px; margin: 2px;" title="Numero ${i}">${i}</div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        function getHeatmapColor(intensity) {
            if (intensity > 0.75) return 'gold';
            if (intensity > 0.5) return 'silver';
            if (intensity > 0.25) return 'bronze';
            return '';
        }

        function updateRitardiDettaglio() {
            const container = document.getElementById('ritardi-dettaglio');
            let html = '';
            
            for (let i = 0; i < 8; i++) {
                const numero = Math.floor(Math.random() * 90) + 1;
                const ritardo = Math.floor(Math.random() * 100) + 50;
                const alertClass = ritardo > 80 ? 'gold' : ritardo > 60 ? 'silver' : '';
                
                html += `
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded fade-in" style="animation-delay: ${i * 0.1}s">
                        <span class="numero-lotto ${alertClass}" style="width: 35px; height: 35px; line-height: 35px; font-size: 14px;">${numero}</span>
                        <div class="text-end">
                            <strong>${ritardo}</strong> <small class="text-muted">giorni</small>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        function updateQuickStats() {
            const stats = {
                'avg-frequency': Math.floor(Math.random() * 50) + 140,
                'avg-delay': Math.floor(Math.random() * 30) + 30,
                'hot-numbers': Math.floor(Math.random() * 5) + 5,
                'cold-numbers': Math.floor(Math.random() * 8) + 10
            };

            Object.entries(stats).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                }
            });
        }

        function updateStats() {
            const btn = document.getElementById('aggiorna-stats');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Aggiornando...';

            setTimeout(() => {
                loadStatsData();
                showToast('Statistiche aggiornate con successo!', 'success');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sync-alt"></i> Aggiorna Dati';
            }, 1500);
        }

        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} position-fixed top-0 end-0 m-3 fade-in`;
            toast.style.zIndex = '9999';
            toast.innerHTML = `
                ${message}
                <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 3000);
        }
    </script>
</body>
</html>
